"""
Утилита для применения данных форума
Применяет все SQL миграции за один вызов
"""
import os
import json
import psycopg2

def handler(event: dict, context) -> dict:
    """Применить все данные форума"""
    method = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type'
            },
            'body': ''
        }
    
    try:
        # Остальные пользователи
        users_sql = """
INSERT INTO forum_users (name, role, bio, experience_years, specialization, created_at) VALUES
('Александра Белова', 'masseur', 'Расслабляющий массаж и ароматерапия.', 5, 'Расслабляющий массаж', '2025-12-15 16:20:00'),
('Кирилл Романов', 'masseur', 'Массаж при остеохондрозе и грыжах.', 14, 'Ортопедический массаж', '2025-12-17 12:45:00'),
('Виктория Гусева', 'masseur', 'Косметический массаж лица и декольте.', 3, 'Косметический массаж', '2025-12-19 09:30:00'),
('Артем Зайцев', 'masseur', 'Массаж для пловцов и триатлетов.', 7, 'Спортивный массаж', '2025-12-21 15:00:00'),
('Людмила Сергеева', 'masseur', 'Лечебный массаж при артритах и артрозах.', 11, 'Лечебный массаж', '2025-12-23 11:10:00'),
('Олег Макаров', 'masseur', 'Массаж при варикозе и венозной недостаточности.', 9, 'Лечебный массаж', '2025-12-25 14:40:00'),
('Марина Тихонова', 'masseur', 'Массаж головы и лица от стресса.', 4, 'Антистресс массаж', '2025-12-27 10:55:00'),
('Константин Борисов', 'masseur', 'Спортивный массаж для велосипедистов.', 6, 'Спортивный массаж', '2025-12-29 16:35:00'),
('Дарья Фролова', 'masseur', 'Общеукрепляющий массаж для пожилых людей.', 8, 'Классический массаж', '2026-01-02 13:20:00'),
('Евгений Крылов', 'masseur', 'Постизометрическая релаксация и растяжки.', 10, 'ПИР-терапия', '2026-01-05 09:50:00'),
('Академия массажа "Профи"', 'school', 'Обучаем классическому и спортивному массажу с 2010 года.', NULL, NULL, '2025-11-01 10:00:00'),
('Школа массажа "Мастер"', 'school', 'Курсы для начинающих и профессионалов, онлайн и офлайн.', NULL, NULL, '2025-11-08 12:30:00'),
('Центр обучения "Целитель"', 'school', 'Специализируемся на восточных техниках массажа.', NULL, NULL, '2025-11-14 15:45:00'),
('Институт массажа СПб', 'school', 'Дипломированные программы, государственная лицензия.', NULL, NULL, '2025-11-21 09:15:00'),
('Школа "Здоровые руки"', 'school', 'Базовые и продвинутые курсы массажа, практика на моделях.', NULL, NULL, '2025-11-28 14:00:00'),
('Академия восточных практик', 'school', 'Тайский, балийский, индийский массаж - обучение с сертификатом.', NULL, NULL, '2025-12-04 11:30:00'),
('Центр "Массажные технологии"', 'school', 'Авторские программы по миофасциальному релизу.', NULL, NULL, '2025-12-10 16:20:00'),
('Школа спортивного массажа', 'school', 'Готовим массажистов для работы со спортсменами.', NULL, NULL, '2025-12-16 10:45:00'),
('Институт остеопатии', 'school', 'Обучение остеопатическим техникам и висцеральной терапии.', NULL, NULL, '2025-12-22 13:15:00'),
('Академия "Новый уровень"', 'school', 'Онлайн-курсы по массажу с поддержкой наставников.', NULL, NULL, '2025-12-28 09:00:00'),
('SPA-центр "Релакс"', 'salon', 'Ищем массажистов для работы в премиум SPA, Москва.', NULL, NULL, '2025-11-16 11:00:00'),
('Центр массажа "Здоровье"', 'salon', 'Сеть кабинетов массажа в Санкт-Петербурге.', NULL, NULL, '2025-12-01 14:30:00'),
('Студия "Гармония тела"', 'salon', 'Уютная студия массажа и йоги, работаем 5 лет.', NULL, NULL, '2025-12-12 10:20:00'),
('Клиника "МедМассаж"', 'salon', 'Медицинский центр с отделением массажа и реабилитации.', NULL, NULL, '2025-12-20 15:45:00'),
('SPA-отель "Горизонт"', 'salon', 'Требуются массажисты в загородный отель.', NULL, NULL, '2026-01-03 12:00:00'),
('Анна Петрова', 'client', 'Ищу хорошего массажиста в Москве.', NULL, NULL, '2025-11-19 16:30:00'),
('Михаил Соловьев', 'client', 'Занимаюсь спортом, нужен массаж после тренировок.', NULL, NULL, '2025-12-06 13:00:00'),
('Елена Красильникова', 'client', 'Интересуюсь антицеллюлитным массажем.', NULL, NULL, '2025-12-14 11:15:00'),
('Дмитрий Алексеев', 'client', 'Проблемы с шеей и спиной, ищу специалиста.', NULL, NULL, '2025-12-24 09:45:00'),
('Светлана Иванова', 'client', 'Хочу научиться самомассажу для поддержания здоровья.', NULL, NULL, '2026-01-08 14:20:00');
"""
        
        conn = psycopg2.connect(os.environ['DATABASE_URL'])
        cur = conn.cursor()
        
        # Применяем SQL
        cur.execute(users_sql)
        users_added = cur.rowcount
        
        conn.commit()
        cur.close()
        conn.close()
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({
                'success': True,
                'users_added': users_added,
                'message': 'Forum users populated successfully'
            })
        }
    
    except Exception as e:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': str(e)})
        }
