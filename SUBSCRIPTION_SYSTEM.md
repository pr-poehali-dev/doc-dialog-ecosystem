# Система тарифов для школ

## Обзор
Вместо разовой оплаты ₽500 за каждый курс, теперь работает система ежемесячных тарифов с лимитами.

## Тарифные планы

### 1. Базовый (₽0/месяц) — Бесплатный
- ✅ 1 курс в месяц
- ✅ 5 сообщений в день в чате
- ❌ Запросы скидок от массажистов недоступны

### 2. Профессиональный (₽5,000/месяц)
- ✅ 3 курса в месяц
- ✅ 5 сообщений в день в чате
- ❌ Запросы скидок от массажистов недоступны

### 3. Безлимит (₽15,000/месяц)
- ✅ Неограниченные курсы
- ✅ Неограниченные сообщения в чате
- ✅ Безлимитные запросы скидок от массажистов

## Структура БД

### Таблицы
1. **subscription_plans** - справочник тарифных планов
2. **school_subscriptions** - активные подписки школ
3. **schools** - добавлены поля для отслеживания использования:
   - `courses_published_this_month` - счётчик курсов за месяц
   - `messages_sent_today` - счётчик сообщений за день
   - `last_message_reset_date` - дата последнего сброса

### Миграция
`V0078__add_subscription_plans_system.sql`

## Backend API

### Функция: `/backend/subscriptions/`
URL: `https://functions.poehali.dev/f81f82f7-d9c7-4858-87bc-6701c67f2187`

#### Endpoints:

**1. GET /?action=subscription_plans**
Получить все доступные тарифы
```json
{
  "plans": [
    {
      "id": 1,
      "name": "Базовый",
      "price": 0,
      "courses_limit": 1,
      "messages_limit_per_day": 5,
      "promo_requests_allowed": false,
      "description": "Бесплатный тариф..."
    }
  ]
}
```

**2. GET /?action=my_subscription**
Получить активную подписку школы и использование
Headers: `X-User-Id: {user_id}`
```json
{
  "subscription": {
    "id": 1,
    "plan": {...},
    "started_at": "2026-01-08T...",
    "expires_at": "2026-02-07T...",
    "is_active": true
  },
  "usage": {
    "courses_published_this_month": 1,
    "messages_sent_today": 3
  }
}
```

**3. POST /?action=activate_subscription**
Активировать тариф
Headers: `X-User-Id: {user_id}`
Body: `{"plan_id": 2}`

- Проверяет баланс школы (для платных тарифов)
- Списывает стоимость с баланса
- Деактивирует старую подписку
- Создаёт новую подписку на 30 дней
- Сбрасывает счётчики использования

## Логика проверки лимитов

### При создании курса (backend/courses/index.py):
1. Получить `school_id` по `user_id`
2. Получить счётчик `courses_published_this_month`
3. Получить активный тариф и его `courses_limit`
4. Если `courses_limit` не NULL и счётчик >= лимита → ошибка 400
5. Иначе: увеличить счётчик и создать курс

### При создании мастермайнда:
Та же логика (мастермайнды считаются как курсы)

## Frontend компоненты

### 1. SubscriptionTab (`src/pages/SchoolDashboard/SubscriptionTab.tsx`)
- Показывает текущий тариф и использование ресурсов
- Отображает все доступные тарифы
- Позволяет активировать/повысить тариф
- Информационный блок с правилами

### 2. Обновлённые предупреждения
- **CourseForm** - синий блок вместо жёлтого
- **MastermindForm** - синий блок вместо жёлтого
- **CourseLandingBuilder** - синий блок вместо жёлтого
- Текст: "Количество публикаций зависит от тарифного плана"

### 3. Новый таб в навигации
`DashboardTabs` → добавлен таб "Тарифы" с иконкой Crown

## Обработка ошибок

### При превышении лимита курсов:
```json
{
  "error": "Превышен лимит курсов для вашего тарифа",
  "limit": 3,
  "used": 3,
  "upgrade_needed": true
}
```

### При недостаточном балансе для активации тарифа:
```json
{
  "error": "Insufficient balance",
  "required": 5000,
  "available": 1200
}
```

## Автоматические сбросы

### Счётчик курсов
Сбрасывается 1-го числа каждого месяца (требует cron job или планировщик)

### Счётчик сообщений
Сбрасывается ежедневно в 00:00 МСК (требует cron job или планировщик)

## TODO (будущие улучшения)
- [ ] Автоматический сброс счётчиков через cron
- [ ] Email-уведомления о приближении к лимиту
- [ ] Email-уведомления об окончании подписки
- [ ] Автопродление подписки при достаточном балансе
- [ ] История подписок
- [ ] Аналитика использования ресурсов
- [ ] Промокоды и скидки на тарифы

## Миграция с старой системы

Старая система (₽500 за курс) заменена на тарифы. Изменения:
1. Удалено списание ₽500 при создании курса/мастермайнда
2. Добавлена проверка лимитов тарифного плана
3. Все существующие школы получают бесплатный тариф "Базовый"
4. Предупреждения в формах обновлены
